(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.reg.get("core","common/extend"),o=flarum.reg.get("core","forum/app");var r=t.n(o);const a=flarum.reg.get("core","forum/components/HeaderSecondary");var n=t.n(a);const s=flarum.reg.get("core","common/components/Button");var i=t.n(s);const l=flarum.reg.get("core","common/utils/extractText");var p=t.n(l);const d=flarum.reg.get("core","common/models/Group");var c=t.n(d);const u=flarum.reg.get("core","common/helpers/textContrastClass");var f=t.n(u);const h=flarum.reg.get("core","common/utils/Stream");var g=t.n(h);function b(t){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},b(t)}function y(t,e,o){return(e=function(t){var e=function(t){if("object"!=b(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var o=e.call(t,"string");if("object"!=b(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==b(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}const _=flarum.reg.get("core","common/components/FormModal");var v=t.n(_);flarum.reg.get("core","forum/components/LogInButtons");const P=flarum.reg.get("core","common/utils/ItemList");var w=t.n(P);function x(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,r)}return o}const L="yippy-auth-ldap.forum.errors.";class k extends(v()){oninit(t){super.oninit(t),this.identification=g()(this.attrs.identification||""),this.password=g()(this.attrs.password||""),this.remember=g()(!!this.attrs.remember)}className(){return"LogInModal Modal--small"}title(){return app.translator.trans("yippy-auth-ldap.forum.log_in_with",{server:app.forum.attribute("yippy-auth-ldap.method_name")})}content(){return[m("div",{className:"Modal-body"},this.body()),m("div",{className:"Modal-footer"},this.footer())]}body(){return[m("div",{className:"Form Form--centered"},this.fields().toArray())]}fields(){const t=new(w()),e=app.translator.trans("core.forum.log_in.username_or_email_placeholder"),o=app.translator.trans("core.forum.log_in.password_placeholder");return t.add("identification",m("div",{className:"Form-group"},e,m("input",{className:"FormControl",name:"identification",type:"text",placeholder:e,bidi:this.identification,disabled:this.attrs.loading})),30),t.add("password",m("div",{className:"Form-group"},o,m("input",{className:"FormControl",name:"password",type:"password",placeholder:o,bidi:this.password,disabled:this.attrs.loading})),20),t.add("submit",m("div",{className:"Form-group"},i().component({className:"Button Button--primary Button--block",name:"submit_log_in",type:"submit",loading:this.attrs.loading},app.translator.trans("core.forum.log_in.submit_button"))),-10),t}footer(){return[]}onready(){this.$("[name="+(this.identification()?"password":"identification")+"]").select()}login(t,e){return void 0===e&&(e={}),app.request(function(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?x(Object(o),!0).forEach((function(e){y(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):x(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}({method:"POST",url:app.forum.attribute("baseUrl")+"/auth/ldap",body:t},e))}onsubmit(t){t.preventDefault(),this.loading=!0,$('input[name="identification"]').prop("disabled",!0),$('input[name="password"]').prop("disabled",!0),$('button[name="submit_log_in"]').prop("disabled",!0);const e={identification:this.identification(),password:this.password(),remember:this.remember(),csrfToken:app.session.csrfToken},o={errorHandler:this.onerror.bind(this),modifyText:this.modifyResponse.bind(this)};this.login(e,o).catch((()=>{}))}modifyResponse(t){if($('input[name="identification"]').prop("disabled",!1),$('input[name="password"]').prop("disabled",!1),$('button[name="submit_log_in"]').prop("disabled",!1),t.indexOf("app.authenticationComplete")>=0){t.replace(/(^.*\{|\}.*$)/g,"");var e=t.match(/[^{\}]+(?=})/g);e.length>0&&app.authenticationComplete(JSON.parse("{"+e[0]+"}"))}else t.indexOf(app.translator.trans(L+"core_csrf_token_mismatch"))>=0&&this.onerror({alert:{content:app.translator.trans(L+"csrf_token_mismatch"),controls:!1,dismissible:!1,type:"error"},status:400,response:{errors:[{code:"csrf_token_mismatch",status:400}]}});return this.loaded(),t}onerror(t){var e=null;if(t.response.errors&&t.response.errors.length>0&&(e=t.response.errors[0].code),401===t.status)switch(e){case"search_filter_is_invalid":case"not_authenticated":case"account.not_found":case"account.disabled":case"account.expired":case"account.locked":t.alert.content=app.translator.trans(L+e,{server:app.forum.attribute("yippy-auth-ldap.method_name")});break;case"account.invalid_inputs":case"account.incorrect_details":case"account.password_expired":case"domains.no_domains":t.alert.content=app.translator.trans(L+e);break;case"domains.empty_host":case"domains.empty_base_dn":t.alert.content=app.translator.trans(L+e,{domain_index:t.response.errors[0].domain_index});break;case"domains.empty_user_username":case"domains.empty_search_field":t.alert.content=app.translator.trans(L+e,{server:app.forum.attribute("yippy-auth-ldap.method_name"),domain_index:t.response.errors[0].domain_index});break;case"domains.username_field_does_not_exist":case"domains.mail_field_does_not_exist":case"domains.connection_failed":t.alert.content=app.translator.trans(L+e,{server:app.forum.attribute("yippy-auth-ldap.method_name"),data:t.response.errors[0].data,domain_index:t.response.errors[0].domain_index})}super.onerror(t)}}flarum.reg.add("yippy-auth-ldap","forum/components/LDAPLogInModal",k);const D="yippy-auth-ldap.forum.";r().initializers.add("yippy-auth-ldap",(()=>{(0,e.extend)(n().prototype,"items",(function(t){t.has("logIn")&&t.add("logInLDAP",i().component({className:"Button Button--link",onclick:()=>r().modal.show(k)},r().translator.trans(D+"log_in_with",{server:r().forum.attribute("yippy-auth-ldap.method_name")})),0)})),(0,e.extend)(n().prototype,"items",(function(t){r().forum.attribute("yippy-auth-ldap.onlyUse")&&(t.has("signUp")&&t.remove("signUp"),t.has("logIn")&&t.remove("logIn"))})),(0,e.extend)("flarum/forum/components/LogInModal","oninit",(function(){r().forum.attribute("yippy-auth-ldap.onlyUse")&&(LogInModal.prototype.content=k.prototype.content,LogInModal.prototype.title=k.prototype.title,LogInModal.prototype.body=k.prototype.body,LogInModal.prototype.fields=k.prototype.fields,LogInModal.prototype.footer=k.prototype.footer,LogInModal.prototype.onerror=k.prototype.onerror,LogInModal.prototype.onready=k.prototype.onready,LogInModal.prototype.onsubmit=k.prototype.onsubmit)})),(0,e.extend)("flarum/forum/components/SignUpModal","oninit",(function(){this.title=function(){return this.attrs.isLDAP?r().translator.trans(D+"account_found",{server:r().forum.attribute("yippy-auth-ldap.method_name")}):r().translator.trans("core.forum.sign_up.title")},this.footer=function(){return this.attrs.isLDAP?[]:[m("p",{className:"SignUpModal-logIn"},r().translator.trans("core.forum.sign_up.log_in_text",{a:m(i(),{className:"Button Button--text Button--link",onclick:this.logIn.bind(this)})}))]}})),(0,e.extend)("flarum/forum/components/SignUpModal","onready",(function(){this.attrs.assignLDAPPermissionGroupList.length>0&&this.$("[name=LDAPSelectDropdown]").select2({dropdownCssClass:":all:",disabled:!0,templateSelection:t=>{var e='<span style="margin-left: -18px; padding: 5px 10px 5px 10px; background-color:'+t.color+';" class="'+f()(t.color)+'">';return t.icon&&(e+='<i class="fa fa-lg '+t.icon.toLowerCase()+'"></i> '),e+(t.text+"</span>")},escapeMarkup:t=>t,width:"100%",multiple:!0,data:this.attrs.assignLDAPPermissionGroupList})})),(0,e.extend)("flarum/forum/components/SignUpModal","fields",(function(t){if(this.attrs.isLDAP){const e=p()(r().translator.trans("core.forum.sign_up.username_placeholder")),o=p()(r().translator.trans("core.forum.sign_up.email_placeholder"));if(p()(r().translator.trans("core.forum.sign_up.password_placeholder")),t.has("username")&&t.add("usernameLabel",m("div",{className:"Form-group"},e),31),this.attrs.assignLDAPPermissionGroupList=[],this.attrs.permissionGroupForLDAP&&Array.isArray(this.attrs.permissionGroupForLDAP)&&this.attrs.permissionGroupForLDAP.length>0){let e=r().store.all("groups").filter((t=>t.id()!==c().MEMBER_ID&&t.id()!==c().GUEST_ID)),o=[];e.forEach((t=>{let e={id:t.data.id,text:t.data.attributes.namePlural,icon:t.data.attributes.icon,color:t.data.attributes.color,isHidden:t.data.attributes.isHidden,namePlural:t.data.attributes.namePlural,nameSingular:t.data.attributes.nameSingular,selected:!0};this.attrs.permissionGroupForLDAP.includes(e.id)&&o.push(e)})),o.length>0&&(this.attrs.assignLDAPPermissionGroupList=o,t.add("permissionGroups",m("div",{className:"Form-group"},"Roles",m("select",{className:"FormControl ",name:"LDAPSelectDropdown"})),19))}if("nickname"===r().forum.attribute("displayNameDriver")){const e=p()(r().translator.trans("flarum-nicknames.forum.sign_up.nickname_placeholder"));t.add("nicknameLabel",m("div",{className:"Form-group"},e),26),this.isProvided("nickname")&&(this.nickname=g()(this.attrs.nickname||""),t.add("nickname",m("div",{className:"Form-group"},m("input",{className:"FormControl",name:"nickname",type:"text",placeholder:p()(r().translator.trans("flarum-nicknames.forum.sign_up.nickname_placeholder")),bidi:this.nickname,disabled:this.loading||this.isProvided("nickname"),required:r().forum.attribute("randomizeUsernameOnRegistration")})),25))}t.has("email")&&t.add("emailLabel",m("div",{className:"Form-group"},o),21)}})),(0,e.override)("flarum/forum/components/SignUpModal","onsubmit",(function(t,e){e.preventDefault(),this.loading=!0;const o=this.submitData();this.attrs.isLDAP?r().request({url:r().forum.attribute("baseUrl")+"/register/ldap",method:"POST",body:o,errorHandler:this.onerror.bind(this)}).then((()=>window.location.reload()),this.loaded.bind(this)):r().request({url:r().forum.attribute("baseUrl")+"/register",method:"POST",body:o,errorHandler:this.onerror.bind(this)}).then((()=>window.location.reload()),this.loaded.bind(this))})),(0,e.extend)("flarum/forum/components/SettingsPage","accountItems",(function(t){t.remove("changeEmail"),t.remove("changePassword")})),(0,e.extend)("flarum/forum/components/SettingsPage","settingsItems",(function(t){t.has("account")&&0===t.get("account").children.length&&t.remove("account")}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map