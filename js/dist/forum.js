(()=>{var t={n:o=>{var e=o&&o.__esModule?()=>o.default:()=>o;return t.d(e,{a:e}),e},d:(o,e)=>{for(var r in e)t.o(e,r)&&!t.o(o,r)&&Object.defineProperty(o,r,{enumerable:!0,get:e[r]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o)};(()=>{"use strict";const o=flarum.core.compat["common/extend"],e=flarum.core.compat["common/app"];var r=t.n(e);const a=flarum.core.compat["components/HeaderSecondary"];var n=t.n(a);const s=flarum.core.compat["components/SettingsPage"];var i=t.n(s);const c=flarum.core.compat["components/Button"];var p=t.n(c);const l=flarum.core.compat["components/LogInModal"];var d=t.n(l);const u=flarum.core.compat["components/SignUpModal"];var f=t.n(u);function h(){return h=Object.assign?Object.assign.bind():function(t){for(var o=1;o<arguments.length;o++){var e=arguments[o];for(var r in e)({}).hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},h.apply(null,arguments)}function y(t,o){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},y(t,o)}flarum.core.compat.extend;const b=flarum.core.compat.app;var _=t.n(b);const g=flarum.core.compat["components/Modal"];var v=t.n(g);flarum.core.compat["components/LogInButtons"];const x=flarum.core.compat["utils/extractText"];var P=t.n(x);const w=flarum.core.compat["utils/ItemList"];var L=t.n(w);const D=flarum.core.compat["utils/Stream"];var k=t.n(D),N="yippy-auth-ldap.forum.errors.",A=function(t){function o(){return t.apply(this,arguments)||this}var e,r;r=t,(e=o).prototype=Object.create(r.prototype),e.prototype.constructor=e,y(e,r);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o),this.identification=k()(this.attrs.identification||""),this.password=k()(this.attrs.password||""),this.remember=k()(!!this.attrs.remember)},a.className=function(){return"LogInModal Modal--small"},a.title=function(){return _().translator.trans("yippy-auth-ldap.forum.log_in_with",{server:_().forum.attribute("yippy-auth-ldap.method_name")})},a.content=function(){return[m("div",{className:"Modal-body"},this.body()),m("div",{className:"Modal-footer"},this.footer())]},a.body=function(){return[m("div",{className:"Form Form--centered"},this.fields().toArray())]},a.fields=function(){var t=new(L()),o=_().translator.trans("core.forum.log_in.username_or_email_placeholder"),e=_().translator.trans("core.forum.log_in.password_placeholder");return t.add("identification",m("div",{className:"Form-group"},o,m("input",{className:"FormControl",name:"identification",type:"text",placeholder:o,bidi:this.identification,disabled:this.attrs.loading})),30),t.add("password",m("div",{className:"Form-group"},e,m("input",{className:"FormControl",name:"password",type:"password",placeholder:e,bidi:this.password,disabled:this.attrs.loading})),20),t.add("submit",m("div",{className:"Form-group"},p().component({className:"Button Button--primary Button--block",name:"submit_log_in",type:"submit",loading:this.attrs.loading},_().translator.trans("core.forum.log_in.submit_button"))),-10),t},a.footer=function(){return[]},a.onready=function(){this.$("[name="+(this.identification()?"password":"identification")+"]").select()},a.login=function(t,o){return void 0===o&&(o={}),_().request(h({method:"POST",url:_().forum.attribute("baseUrl")+"/auth/ldap",body:t},o))},a.onsubmit=function(t){t.preventDefault(),this.loading=!0,$('input[name="identification"]').prop("disabled",!0),$('input[name="password"]').prop("disabled",!0),$('button[name="submit_log_in"]').prop("disabled",!0);var o={identification:this.identification(),password:this.password(),remember:this.remember(),csrfToken:_().session.csrfToken},e={errorHandler:this.onerror.bind(this),modifyText:this.modifyResponse.bind(this)};this.login(o,e).catch((function(){}))},a.modifyResponse=function(t){if($('input[name="identification"]').prop("disabled",!1),$('input[name="password"]').prop("disabled",!1),$('button[name="submit_log_in"]').prop("disabled",!1),t.indexOf("app.authenticationComplete")>=0){t.replace(/(^.*\{|\}.*$)/g,"");var o=t.match(/[^{\}]+(?=})/g);o.length>0&&_().authenticationComplete(JSON.parse("{"+o[0]+"}"))}else t.indexOf(_().translator.trans(N+"core_csrf_token_mismatch"))>=0&&this.onerror({alert:{content:_().translator.trans(N+"csrf_token_mismatch"),controls:!1,dismissible:!1,type:"error"},status:400,response:{errors:[{code:"csrf_token_mismatch",status:400}]}});return this.loaded(),t},a.onerror=function(o){var e=null;if(o.response.errors&&o.response.errors.length>0&&(e=o.response.errors[0].code),401===o.status)switch(e){case"search_filter_is_invalid":case"not_authenticated":case"account.not_found":case"account.disabled":case"account.expired":case"account.locked":o.alert.content=_().translator.trans(N+e,{server:_().forum.attribute("yippy-auth-ldap.method_name")});break;case"account.invalid_inputs":case"account.incorrect_details":case"account.password_expired":case"domains.no_domains":o.alert.content=_().translator.trans(N+e);break;case"domains.empty_host":case"domains.empty_base_dn":o.alert.content=_().translator.trans(N+e,{domain_index:o.response.errors[0].domain_index});break;case"domains.empty_user_username":case"domains.empty_search_field":o.alert.content=_().translator.trans(N+e,{server:_().forum.attribute("yippy-auth-ldap.method_name"),domain_index:o.response.errors[0].domain_index});break;case"domains.username_field_does_not_exist":case"domains.mail_field_does_not_exist":o.alert.content=_().translator.trans(N+e,{server:_().forum.attribute("yippy-auth-ldap.method_name"),data:o.response.errors[0].data,domain_index:o.response.errors[0].domain_index})}t.prototype.onerror.call(this,o)},o}(v());const O=flarum.core.compat["common/models/Group"];var F=t.n(O);const S=flarum.core.compat["common/helpers/textContrastClass"];var I=t.n(S),M="yippy-auth-ldap.forum.";r().initializers.add("yippy-auth-ldap",(function(){(0,o.extend)(n().prototype,"items",(function(t){t.has("logIn")&&t.add("logInLDAP",p().component({className:"Button Button--link",onclick:function(){return r().modal.show(A)}},r().translator.trans(M+"log_in_with",{server:r().forum.attribute("yippy-auth-ldap.method_name")})),0)})),(0,o.extend)(n().prototype,"items",(function(t){r().forum.attribute("yippy-auth-ldap.onlyUse")&&(t.has("signUp")&&t.remove("signUp"),t.has("logIn")&&t.remove("logIn"))})),(0,o.extend)(d().prototype,"content",(function(){r().forum.attribute("yippy-auth-ldap.onlyUse")&&(d().prototype.content=A.prototype.content,d().prototype.title=A.prototype.title,d().prototype.body=A.prototype.body,d().prototype.fields=A.prototype.fields,d().prototype.footer=A.prototype.footer,d().prototype.onerror=A.prototype.onerror,d().prototype.onready=A.prototype.onready,d().prototype.onsubmit=A.prototype.onsubmit)})),(0,o.extend)(f().prototype,"fields",(function(t){var o=this;if(this.attrs.isLDAP){var e=P()(r().translator.trans("core.forum.sign_up.username_placeholder")),a=P()(r().translator.trans("core.forum.sign_up.email_placeholder"));if(P()(r().translator.trans("core.forum.sign_up.password_placeholder")),t.has("username")&&t.add("usernameLabel",m("div",{className:"Form-group"},e),31),this.attrs.assignLDAPPermissionGroupList=[],this.attrs.permissionGroupForLDAP&&Array.isArray(this.attrs.permissionGroupForLDAP)&&this.attrs.permissionGroupForLDAP.length>0){var n=r().store.all("groups").filter((function(t){return t.id()!==F().MEMBER_ID&&t.id()!==F().GUEST_ID})),s=[];n.forEach((function(t){var e={id:t.data.id,text:t.data.attributes.namePlural,icon:t.data.attributes.icon,color:t.data.attributes.color,isHidden:t.data.attributes.isHidden,namePlural:t.data.attributes.namePlural,nameSingular:t.data.attributes.nameSingular,selected:!0};o.attrs.permissionGroupForLDAP.includes(e.id)&&s.push(e)})),s.length>0&&(this.attrs.assignLDAPPermissionGroupList=s,t.add("permissionGroups",m("div",{className:"Form-group"},"Roles",m("select",{className:"FormControl ",name:"LDAPSelectDropdown"})),19))}if("nickname"===r().forum.attribute("displayNameDriver")){var i=P()(r().translator.trans("flarum-nicknames.forum.sign_up.nickname_placeholder"));t.add("nicknameLabel",m("div",{className:"Form-group"},i),26)}t.has("email")&&t.add("emailLabel",m("div",{className:"Form-group"},a),21)}})),(0,o.extend)(f().prototype,"onready",(function(){this.attrs.assignLDAPPermissionGroupList.length>0&&this.$("[name=LDAPSelectDropdown]").select2({dropdownCssClass:":all:",disabled:!0,templateSelection:function(t){var o='<span style="margin-left: -18px; padding: 5px 10px 5px 10px; background-color:'+t.color+';" class="'+I()(t.color)+'">';return t.icon&&(o+='<i class="fa fa-lg '+t.icon.toLowerCase()+'"></i> '),o+(t.text+"</span>")},escapeMarkup:function(t){return t},width:"100%",multiple:!0,data:this.attrs.assignLDAPPermissionGroupList})})),f().prototype.title=function(){return this.attrs.isLDAP?r().translator.trans(M+"account_found",{server:r().forum.attribute("yippy-auth-ldap.method_name")}):r().translator.trans("core.forum.sign_up.title")},f().prototype.footer=function(){return this.attrs.isLDAP?[]:[m("p",{className:"SignUpModal-logIn"},r().translator.trans("core.forum.sign_up.log_in_text",{a:m("a",{onclick:this.logIn.bind(this)})}))]},(0,o.override)(f().prototype,"onsubmit",(function(t,o){o.preventDefault(),this.loading=!0;var e=this.submitData();this.attrs.isLDAP?r().request({url:r().forum.attribute("baseUrl")+"/register/ldap",method:"POST",body:e,errorHandler:this.onerror.bind(this)}).then((function(){return window.location.reload()}),this.loaded.bind(this)):r().request({url:r().forum.attribute("baseUrl")+"/register",method:"POST",body:e,errorHandler:this.onerror.bind(this)}).then((function(){return window.location.reload()}),this.loaded.bind(this))})),(0,o.extend)(i().prototype,"accountItems",(function(t){t.remove("changeEmail"),t.remove("changePassword")})),(0,o.extend)(i().prototype,"settingsItems",(function(t){t.has("account")&&0===t.get("account").children.length&&t.remove("account")}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map