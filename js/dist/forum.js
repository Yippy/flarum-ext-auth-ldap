(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.reg.get("core","common/extend"),o=flarum.reg.get("core","forum/app");var r=t.n(o);const n=flarum.reg.get("core","forum/components/HeaderSecondary");var a=t.n(n);const s=flarum.reg.get("core","common/components/Button");var i=t.n(s);const p=flarum.reg.get("core","common/utils/extractText");var l=t.n(p);function d(t){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d(t)}function c(t,e,o){return(e=function(t){var e=function(t){if("object"!=d(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var o=e.call(t,"string");if("object"!=d(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==d(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}const u=flarum.reg.get("core","common/components/FormModal");var f=t.n(u);flarum.reg.get("core","forum/components/LogInButtons");const h=flarum.reg.get("core","common/utils/ItemList");var y=t.n(h);const b=flarum.reg.get("core","common/utils/Stream");var g=t.n(b);function _(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,r)}return o}const v="yippy-auth-ldap.forum.errors.";class w extends(f()){oninit(t){super.oninit(t),this.identification=g()(this.attrs.identification||""),this.password=g()(this.attrs.password||""),this.remember=g()(!!this.attrs.remember)}className(){return"LogInModal Modal--small"}title(){return app.translator.trans("yippy-auth-ldap.forum.log_in_with",{server:app.forum.attribute("yippy-auth-ldap.method_name")})}content(){return[m("div",{className:"Modal-body"},this.body()),m("div",{className:"Modal-footer"},this.footer())]}body(){return[m("div",{className:"Form Form--centered"},this.fields().toArray())]}fields(){const t=new(y()),e=app.translator.trans("core.forum.log_in.username_or_email_placeholder"),o=app.translator.trans("core.forum.log_in.password_placeholder");return t.add("identification",m("div",{className:"Form-group"},e,m("input",{className:"FormControl",name:"identification",type:"text",placeholder:e,bidi:this.identification,disabled:this.attrs.loading})),30),t.add("password",m("div",{className:"Form-group"},o,m("input",{className:"FormControl",name:"password",type:"password",placeholder:o,bidi:this.password,disabled:this.attrs.loading})),20),t.add("submit",m("div",{className:"Form-group"},i().component({className:"Button Button--primary Button--block",name:"submit_log_in",type:"submit",loading:this.attrs.loading},app.translator.trans("core.forum.log_in.submit_button"))),-10),t}footer(){return[]}onready(){this.$("[name="+(this.identification()?"password":"identification")+"]").select()}login(t,e){return void 0===e&&(e={}),app.request(function(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?_(Object(o),!0).forEach((function(e){c(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):_(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}({method:"POST",url:app.forum.attribute("baseUrl")+"/auth/ldap",body:t},e))}onsubmit(t){t.preventDefault(),this.loading=!0,$('input[name="identification"]').prop("disabled",!0),$('input[name="password"]').prop("disabled",!0),$('button[name="submit_log_in"]').prop("disabled",!0);const e={identification:this.identification(),password:this.password(),remember:this.remember(),csrfToken:app.session.csrfToken},o={errorHandler:this.onerror.bind(this),modifyText:this.modifyResponse.bind(this)};this.login(e,o).catch((()=>{}))}modifyResponse(t){if($('input[name="identification"]').prop("disabled",!1),$('input[name="password"]').prop("disabled",!1),$('button[name="submit_log_in"]').prop("disabled",!1),t.indexOf("app.authenticationComplete")>=0){t.replace(/(^.*\{|\}.*$)/g,"");var e=t.match(/[^{\}]+(?=})/g);e.length>0&&app.authenticationComplete(JSON.parse("{"+e[0]+"}"))}else t.indexOf(app.translator.trans(v+"core_csrf_token_mismatch"))>=0&&this.onerror({alert:{content:app.translator.trans(v+"csrf_token_mismatch"),controls:!1,dismissible:!1,type:"error"},status:400,response:{errors:[{code:"csrf_token_mismatch",status:400}]}});return this.loaded(),t}onerror(t){var e=null;if(t.response.errors&&t.response.errors.length>0&&(e=t.response.errors[0].code),401===t.status)switch(e){case"search_filter_is_invalid":case"not_authenticated":case"account.not_found":case"account.disabled":case"account.expired":case"account.locked":t.alert.content=app.translator.trans(v+e,{server:app.forum.attribute("yippy-auth-ldap.method_name")});break;case"account.invalid_inputs":case"account.incorrect_details":case"account.password_expired":case"domains.no_domains":t.alert.content=app.translator.trans(v+e);break;case"domains.empty_host":case"domains.empty_base_dn":t.alert.content=app.translator.trans(v+e,{domain_index:t.response.errors[0].domain_index});break;case"domains.empty_user_username":case"domains.empty_search_field":t.alert.content=app.translator.trans(v+e,{server:app.forum.attribute("yippy-auth-ldap.method_name"),domain_index:t.response.errors[0].domain_index});break;case"domains.username_field_does_not_exist":case"domains.mail_field_does_not_exist":case"domains.connection_failed":t.alert.content=app.translator.trans(v+e,{server:app.forum.attribute("yippy-auth-ldap.method_name"),data:t.response.errors[0].data,domain_index:t.response.errors[0].domain_index})}super.onerror(t)}}flarum.reg.add("yippy-auth-ldap","forum/components/LDAPLogInModal",w);const x="yippy-auth-ldap.forum.";r().initializers.add("yippy-auth-ldap",(()=>{(0,e.extend)(a().prototype,"items",(function(t){t.has("logIn")&&t.add("logInLDAP",i().component({className:"Button Button--link",onclick:()=>r().modal.show(w)},r().translator.trans(x+"log_in_with",{server:r().forum.attribute("yippy-auth-ldap.method_name")})),0)})),(0,e.extend)(a().prototype,"items",(function(t){r().forum.attribute("yippy-auth-ldap.onlyUse")&&(t.has("signUp")&&t.remove("signUp"),t.has("logIn")&&t.remove("logIn"))})),(0,e.extend)("flarum/forum/components/LogInModal","oninit",(function(){r().forum.attribute("yippy-auth-ldap.onlyUse")&&(LogInModal.prototype.content=w.prototype.content,LogInModal.prototype.title=w.prototype.title,LogInModal.prototype.body=w.prototype.body,LogInModal.prototype.fields=w.prototype.fields,LogInModal.prototype.footer=w.prototype.footer,LogInModal.prototype.onerror=w.prototype.onerror,LogInModal.prototype.onready=w.prototype.onready,LogInModal.prototype.onsubmit=w.prototype.onsubmit)})),(0,e.extend)("flarum/forum/components/SignUpModal","oninit",(function(){this.title=function(){return this.attrs.isLDAP?r().translator.trans(x+"account_found",{server:r().forum.attribute("yippy-auth-ldap.method_name")}):r().translator.trans("core.forum.sign_up.title")},this.footer=function(){return this.attrs.isLDAP?[]:[m("p",{className:"SignUpModal-logIn"},r().translator.trans("core.forum.sign_up.log_in_text",{a:m(i(),{className:"Button Button--text Button--link",onclick:this.logIn.bind(this)})}))]}})),(0,e.extend)("flarum/forum/components/SignUpModal","fields",(function(t){if(this.attrs.isLDAP){const e=l()(r().translator.trans("core.forum.sign_up.username_placeholder")),o=l()(r().translator.trans("core.forum.sign_up.email_placeholder"));if(l()(r().translator.trans("core.forum.sign_up.password_placeholder")),t.has("username")&&t.add("usernameLabel",m("div",{className:"Form-group"},e),31),"nickname"===r().forum.attribute("displayNameDriver")&&this.isProvided("nickname")){const e=l()(r().translator.trans("flarum-nicknames.forum.sign_up.nickname_placeholder"));t.add("nicknameLabel",m("div",{className:"Form-group"},e),26)}t.has("email")&&t.add("emailLabel",m("div",{className:"Form-group"},o),21)}})),(0,e.override)("flarum/forum/components/SignUpModal","onsubmit",(function(t,e){e.preventDefault(),this.loading=!0;const o=this.submitData();this.attrs.isLDAP?r().request({url:r().forum.attribute("baseUrl")+"/register/ldap",method:"POST",body:o,errorHandler:this.onerror.bind(this)}).then((()=>window.location.reload()),this.loaded.bind(this)):r().request({url:r().forum.attribute("baseUrl")+"/register",method:"POST",body:o,errorHandler:this.onerror.bind(this)}).then((()=>window.location.reload()),this.loaded.bind(this))})),(0,e.extend)("flarum/forum/components/SettingsPage","accountItems",(function(t){t.remove("changeEmail"),t.remove("changePassword")})),(0,e.extend)("flarum/forum/components/SettingsPage","settingsItems",(function(t){t.has("account")&&0===t.get("account").children.length&&t.remove("account")}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map